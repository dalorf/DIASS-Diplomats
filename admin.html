<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Diploma 2 Awards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .admin-login {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .login-card {
            background: white;
            border-radius: 2rem;
            padding: 2.5rem;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-icon {
            width: 5rem;
            height: 5rem;
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
        }

        .login-title {
            font-size: 1.75rem;
            color: #333;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .login-subtitle {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: #333;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #ddd;
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #f44336;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1);
        }

        .error-message {
            color: #f44336;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(244, 67, 54, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .admin-dashboard {
            display: none;
            padding: 2rem 0;
        }

        .admin-dashboard.active {
            display: block;
        }

        .dashboard-header {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .dashboard-title {
            font-size: 2rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-logout {
            background: #f44336;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: #d32f2f;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            color: white;
            text-align: center;
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .section-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn-action {
            padding: 1rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-export {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
        }

        .btn-lock {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .btn-reset {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        thead {
            background: #f5f5f5;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            color: #666;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-online {
            background: #e8f5e9;
            color: #4caf50;
        }

        .status-offline {
            background: #fff3e0;
            color: #ff9800;
        }

        .status-never {
            background: #ffebee;
            color: #f44336;
        }

        .results-grid {
            display: grid;
            gap: 1rem;
        }

        .result-card {
            background: #f5f9ff;
            border-radius: 1rem;
            padding: 1.5rem;
            border-left: 4px solid #2196f3;
        }

        .result-header {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nominee-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .nominee-result:last-child {
            margin-bottom: 0;
        }

        .nominee-name {
            font-weight: 500;
            color: #333;
        }

        .nominee-votes {
            font-weight: bold;
            color: #2196f3;
        }

        .live-indicator {
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }

        .search-box:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .log-item {
            padding: 0.75rem;
            background: #f5f5f5;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 768px) {
            .dashboard-title {
                font-size: 1.5rem;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .action-buttons {
                grid-template-columns: 1fr;
            }
            table {
                font-size: 0.8rem;
            }
            th, td {
                padding: 0.75rem 0.5rem;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .btn-delete {
            background: #f44336;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-cancel {
            flex: 1;
            background: #9e9e9e;
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-submit {
            flex: 1;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="adminLogin" class="admin-login">
        <div class="login-card">
            <div class="login-icon">üîí</div>
            <h2 class="login-title">Admin Access</h2>
            <p class="login-subtitle">Enter admin password to continue</p>
            <div class="form-group">
                <label for="passwordInput">Password</label>
                <input type="password" id="passwordInput" placeholder="Enter admin password" autocomplete="current-password">
                <div class="error-message" id="passwordError">Incorrect password</div>
            </div>
            <button class="btn-primary" onclick="handleAdminLogin()">Access Dashboard</button>
        </div>
    </div>

    <div id="adminDashboard" class="admin-dashboard container">
        <div class="dashboard-header">
            <div class="header-top">
                <h1 class="dashboard-title">
                    <span class="live-indicator"></span>
                    Admin Dashboard
                </h1>
                <button class="btn-logout" onclick="handleLogout()">Logout</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalVotes">0</div>
                    <div class="stat-label">Total Votes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalVoters">0</div>
                    <div class="stat-label">Active Voters</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="freeVotesCount">0</div>
                    <div class="stat-label">Free Votes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="paidVotesCount">0</div>
                    <div class="stat-label">Paid Votes</div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn-action btn-export" onclick="exportResults()">üì• Export Results (CSV)</button>
            <button class="btn-action btn-lock" onclick="toggleVoting()" id="lockBtn">üîí Lock Voting</button>
            <button class="btn-action" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white;" onclick="changeAdminPassword()">üîë Change Password</button>
            <button class="btn-action" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white;" onclick="showAddStudentModal()">‚ûï Add Student</button>
            <button class="btn-action btn-reset" onclick="resetVotes()">üîÑ Reset All Votes</button>
        </div>

        <div class="section-card">
            <h2 class="section-title">üîç Recent Security Events</h2>
            <div id="securityLogs" style="max-height: 300px; overflow-y: auto;">
                <p style="text-align: center; color: #666;">Loading security logs...</p>
            </div>
        </div>

        <div class="section-card">
            <h2 class="section-title">üìã All Registered Students</h2>
            <input type="text" class="search-box" id="studentSearch" placeholder="Search students..." onkeyup="filterStudents()">
            <div class="table-container">
                <table id="studentsTable">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Votes Cast</th>
                            <th>Last Activity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <tr><td colspan="6" style="text-align: center; padding: 2rem;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section-card">
            <h2 class="section-title">üèÜ Detailed Voting Results</h2>
            <div class="results-grid" id="resultsContainer">
                <p style="text-align: center; color: #666;">Loading results...</p>
            </div>
        </div>
    </div>

    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header">‚ûï Add New Student</h3>
            <div class="form-group">
                <label for="newStudentName">Full Name</label>
                <input type="text" id="newStudentName" placeholder="e.g., Solomon Stephen Sunday">
            </div>
            <div class="form-group">
                <label for="newStudentEmail">Email (Optional)</label>
                <input type="email" id="newStudentEmail" placeholder="e.g., student@email.com">
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeAddStudentModal()">Cancel</button>
                <button class="btn-submit" onclick="addStudent()">Add Student</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, remove, push } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1tYPF1ZlGAe7gzXxlo6rjw2QMeaZ_MHo",
            authDomain: "diass-year-2-dipards.firebaseapp.com",
            databaseURL: "https://diass-year-2-dipards-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "diass-year-2-dipards",
            storageBucket: "diass-year-2-dipards.firebasestorage.app",
            messagingSenderId: "1093369035381",
            appId: "1:1093369035381:web:129a5fb1b1a029efa3963c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const MAX_ATTEMPTS = 3;
        const LOCKOUT_TIME = 5 * 60 * 1000;

        let loginAttempts = 0;
        let lastAttemptTime = 0;
        let registeredStudents = [];
        let studentsData = {};
        let allVotes = {};
        let votingLocked = false;
        let unsubscribers = [];

        const categories = [
            { name: "Most Brilliant Diplomat", icon: "üéì", nominees: ["Ogunlade Pelumi", "Christian Ogala", "Daibu Fareedah", "Solomon Stephen", "Nicholas Mirabel"] },
            { name: "Most Handsome Diplomat", icon: "üëî", nominees: ["Adebayo Julius", "Salimon Farouq", "Solomon Stephen", "Olanrewaju Bolu"] },
            { name: "Most Beautiful Diplomat", icon: "üëó", nominees: ["Nwanedo Chidera", "Donatus Chidera", "Shobayo Simbi", "Nicholas Mirabel", "Seyi Gandonu"] },
            { name: "Most Reserved Diplomat (Male)", icon: "ü§ê", nominees: ["MOR", "Christian Ogala", "Biggie"] },
            { name: "Most Reserved Diplomat (Female)", icon: "ü§´", nominees: ["Treasure Ebube", "Solomon Joy", "Temmy"] },
            { name: "Most Talented Diplomat", icon: "üé≠", nominees: ["Ernest Henry", "Bolu Olanrewaju", "Ugochukwu Christsanctus", "Solomon Stephen"] },
            { name: "Most Creative Diplomat", icon: "üé®", nominees: ["Daibu Fareedah", "MOR", "Solomon Stephen", "Ernest Henry"] },
            { name: "Most Social Diplomat (Male)", icon: "üéâ", nominees: ["Ernest Henry", "Ayo Salimon Farouq", "Ugo Christsanctus"] },
            { name: "Most Social Diplomat (Female)", icon: "üíÉ", nominees: ["Debby Donatus", "Kowiat", "Abimbola"] },
            { name: "Most Entrepreneurial Diplomat", icon: "üíº", nominees: ["Nicholas Mirabel", "Debby Donatus", "MOH", "Olakunle Kazeem"] },
            { name: "Most Popular Diplomat (Male)", icon: "‚≠ê", nominees: ["Henry Ernest", "Ugochukwu Christsanctus", "Adebayo Julius"] },
            { name: "Most Popular Diplomat (Female)", icon: "‚ú®", nominees: ["Ashley Favour", "Shobayo Simbi", "Gift"] },
            { name: "Favorite Diploma Lecturer", icon: "üìö", nominees: ["Mr. Wilson", "Prof. Falode", "Mr. Femi"] },
            { name: "Most Expensive Diplomat (Male)", icon: "üíé", nominees: ["Kazeem Olakunle", "Ayo Briefcase Guy"] },
            { name: "Most Expensive Diplomat (Female)", icon: "üíç", nominees: ["Tess Nwanedo Chidera", "Chidera Donatus"] },
            { name: "Diploma Fashionista (Male)", icon: "üï¥Ô∏è", nominees: ["Henry Ernest", "Bolu Olanrewaju", "Christian Farouq", "Emmy Indebted"] },
            { name: "Diploma Fashionista (Female)", icon: "üë†", nominees: ["Kowiat", "Tess", "Ifeoma", "Simbi"] },
            { name: "Most Outstanding Diplomat", icon: "üèÜ", nominees: ["Solomon Stephen", "Mr. Chris", "Ernest Henry", "Nicholas Mirabel", "Daibu Fareedah"] }
        ];

        function sanitizeInput(input) {
            if (!input) return '';
            return String(input).replace(/[<>"'`\\]/g, "").trim();
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            return hash.toString();
        }

        window.handleAdminLogin = async function() {
            const now = Date.now();
            const passwordInput = document.getElementById('passwordInput');
            const errorMsg = document.getElementById('passwordError');
            let password = sanitizeInput(passwordInput.value);
            errorMsg.classList.remove('show');

            if (loginAttempts >= MAX_ATTEMPTS) {
                const timeSinceLastAttempt = now - lastAttemptTime;
                if (timeSinceLastAttempt < LOCKOUT_TIME) {
                    const remainingTime = Math.ceil((LOCKOUT_TIME - timeSinceLastAttempt) / 60000);
                    errorMsg.textContent = `üö´ Too many failed attempts. Wait ${remainingTime} min.`;
                    errorMsg.classList.add('show');
                    return;
                }
                loginAttempts = 0;
            }

            if (!password || password.length < 6) {
                errorMsg.textContent = 'Password must be at least 6 characters';
                errorMsg.classList.add('show');
                return;
            }

            try {
                const passwordRef = ref(db, 'settings/adminPasswordHash');
                const snapshot = await get(passwordRef);

                if (!snapshot.exists()) {
                    errorMsg.textContent = '‚ö†Ô∏è Admin password not configured';
                    errorMsg.classList.add('show');
                    return;
                }

                const storedHash = String(snapshot.val());
                const enteredHash = simpleHash(password);

                if (enteredHash === storedHash) {
                    loginAttempts = 0;
                    document.getElementById('adminLogin').style.display = 'none';
                    document.getElementById('adminDashboard').classList.add('active');
                    await logAction('login', true);
                    loadDashboardData();
                } else {
                    loginAttempts++;
                    lastAttemptTime = now;
                    await logAction('login_failed', false, { attempts: loginAttempts });
                    const remaining = MAX_ATTEMPTS - loginAttempts;
                    if (remaining > 0) {
                        errorMsg.textContent = `Incorrect password. ${remaining} attempt(s) left`;
                    } else {
                        errorMsg.textContent = 'Account locked for 5 minutes';
                        passwordInput.disabled = true;
                        setTimeout(() => {
                            passwordInput.disabled = false;
                            errorMsg.classList.remove('show');
                        }, LOCKOUT_TIME);
                    }
                    errorMsg.classList.add('show');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorMsg.textContent = '‚ùå Connection error';
                errorMsg.classList.add('show');
            }
        };

        async function logAction(action, success, extraData = {}) {
            try {
                await set(ref(db, `adminLogs/${Date.now()}`), {
                    action,
                    timestamp: Date.now(),
                    success,
                    ...extraData
                });
            } catch (error) {
                console.error('Error logging action:', error);
            }
        }

        window.handleLogout = function() {
            if (confirm('Logout from admin dashboard?')) {
                unsubscribers.forEach(unsub => unsub());
                unsubscribers = [];
                document.getElementById('adminLogin').style.display = 'flex';
                document.getElementById('adminDashboard').classList.remove('active');
                document.getElementById('passwordInput').value = '';
            }
        };

        window.showAddStudentModal = function() {
            document.getElementById('addStudentModal').classList.add('active');
            document.getElementById('newStudentName').value = '';
            document.getElementById('newStudentEmail').value = '';
        };

        window.closeAddStudentModal = function() {
            document.getElementById('addStudentModal').classList.remove('active');
        };

        window.addStudent = async function() {
            const name = sanitizeInput(document.getElementById('newStudentName').value);
            const email = sanitizeInput(document.getElementById('newStudentEmail').value);

            if (!name || name.length < 2) {
                alert('Please enter a valid student name (at least 2 characters)');
                return;
            }

            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            try {
                const newStudentRef = push(ref(db, 'registeredStudents'));
                
                await set(newStudentRef, {
                    name: name,
                    email: email || null,
                    hasVoted: false,
                    registeredAt: Date.now()
                });

                await logAction('student_added', true, { studentName: name });

                alert(`Student "${name}" added successfully!`);
                closeAddStudentModal();
            } catch (error) {
                console.error('Error adding student:', error);
                alert('Error adding student. Please try again.');
            }
        };

        async function loadDashboardData() {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];

            const registeredUnsubscribe = onValue(ref(db, 'registeredStudents'), (snapshot) => {
                registeredStudents = [];
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    Object.keys(data).forEach(studentKey => {
                        const studentData = data[studentKey];
                        
                        if (studentData && typeof studentData === 'object' && studentData.name) {
                            registeredStudents.push({
                                id: studentKey,
                                name: studentData.name,
                                email: studentData.email || null,
                                hasVoted: studentData.hasVoted || false,
                                registeredAt: studentData.registeredAt || null
                            });
                        }
                    });
                }
                
                renderStudentsTable();
            });
            unsubscribers.push(registeredUnsubscribe);

            const studentsUnsubscribe = onValue(ref(db, 'students'), (snapshot) => {
                studentsData = snapshot.exists() ? snapshot.val() : {};
                renderStudentsTable();
                updateStats();
            });
            unsubscribers.push(studentsUnsubscribe);

            const votesUnsubscribe = onValue(ref(db, 'categoryVotes'), (snapshot) => {
                allVotes = snapshot.exists() ? snapshot.val() : {};
                renderResults();
                updateStats();
            });
            unsubscribers.push(votesUnsubscribe);

            const lockUnsubscribe = onValue(ref(db, 'settings/votingLocked'), (snapshot) => {
                votingLocked = snapshot.exists() ? snapshot.val() : false;
                document.getElementById('lockBtn').textContent = votingLocked ? 'üîì Unlock Voting' : 'üîí Lock Voting';
            });
            unsubscribers.push(lockUnsubscribe);

            loadSecurityLogs();
        }

        function loadSecurityLogs() {
            const logsRef = ref(db, 'adminLogs');
            const logsUnsubscribe = onValue(logsRef, (snapshot) => {
                const logsContainer = document.getElementById('securityLogs');
                
                if (!snapshot.exists()) {
                    logsContainer.innerHTML = '<p style="text-align: center; color: #666;">No security events yet</p>';
                    return;
                }

                const logs = [];
                snapshot.forEach(child => {
                    const logData = child.val();
                    if (logData && logData.timestamp) {
                        logs.push({ key: child.key, ...logData });
                    }
                });
                
                if (logs.length === 0) {
                    logsContainer.innerHTML = '<p style="text-align: center; color: #666;">No security events yet</p>';
                    return;
                }
                
                logs.sort((a, b) => b.timestamp - a.timestamp);
                logsContainer.innerHTML = '';

                logs.slice(0, 20).forEach(log => {
                    const logItem = document.createElement('div');
                    logItem.className = 'log-item';
                    const icon = log.success ? '‚úÖ' : '‚ùå';
                    const color = log.success ? '#4caf50' : '#f44336';
                    const actionText = log.action === 'login' ? 'Admin Login' :
                        log.action === 'login_failed' ? `Failed Login (Attempt ${log.attempts || ''})` :
                        log.action === 'password_changed' ? 'Password Changed' :
                        log.action === 'password_change_attempted' ? 'Password Change Attempted' :
                        log.action === 'voting_locked' ? 'Voting Locked' :
                        log.action === 'voting_unlocked' ? 'Voting Unlocked' :
                        log.action === 'votes_reset' ? 'All Votes Reset' :
                        log.action === 'results_exported' ? 'Results Exported' :
                        log.action === 'student_added' ? `Student Added: ${log.studentName || ''}` :
                        log.action === 'student_deleted' ? `Student Deleted: ${log.studentName || ''}` :
                        log.action;
                    logItem.innerHTML = `
                        <span><strong style="color: ${color}">${icon} ${actionText}</strong></span>
                        <span style="color: #666; font-size: 0.85rem;">${formatTime(log.timestamp)}</span>
                    `;
                    logsContainer.appendChild(logItem);
                });
            }, (error) => {
                console.error('Error loading security logs:', error);
                const logsContainer = document.getElementById('securityLogs');
                logsContainer.innerHTML = '<p style="text-align: center; color: #f44336;">‚ö†Ô∏è Error loading security logs</p>';
            });
            unsubscribers.push(logsUnsubscribe);
        }

        window.changeAdminPassword = async function() {
            alert("‚ö†Ô∏è For security, passwords must be changed manually by a system administrator in Firebase Console.");
            await logAction('password_change_attempted', false);
        };

        async function updateStats() {
            let totalVotes = 0, freeVotes = 0, paidVotes = 0, activeVoters = 0;

            Object.values(allVotes).forEach(category => {
                Object.values(category).forEach(count => totalVotes += count);
            });

            try {
                const userVotesSnapshot = await get(ref(db, 'userVotes'));
                if (userVotesSnapshot.exists()) {
                    Object.values(userVotesSnapshot.val()).forEach(user => {
                        if (user.votes) {
                            freeVotes += Object.keys(user.votes).length;
                            activeVoters++;
                        }
                        if (user.extraVotes) paidVotes += user.extraVotes;
                    });
                }
            } catch (error) {
                console.error('Error fetching user votes:', error);
            }

            document.getElementById('totalVotes').textContent = totalVotes;
            document.getElementById('totalVoters').textContent = activeVoters;
            document.getElementById('freeVotesCount').textContent = freeVotes;
            document.getElementById('paidVotesCount').textContent = paidVotes;
        }

        function renderStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            if (registeredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #666;">No students registered yet</td></tr>';
                return;
            }

            registeredStudents.forEach(student => {
                const studentName = student.name;
                const studentEmail = student.email || 'No email provided';
                
                let studentData = null;
                let votesCount = 0;
                let lastActivity = null;
                let status = 'never';
                
                if (student.email) {
                    const emailKey = student.email.replace(/\./g, ',');
                    if (studentsData[emailKey]) {
                        studentData = studentsData[emailKey];
                    }
                }
                
                if (!studentData) {
                    const nameNormalized = studentName.toLowerCase().replace(/\s+/g, '');
                    for (let key in studentsData) {
                        const data = studentsData[key];
                        if (data && data.name) {
                            const dataNormalized = data.name.toLowerCase().replace(/\s+/g, '');
                            if (dataNormalized === nameNormalized) {
                                studentData = data;
                                break;
                            }
                        }
                    }
                }
                
                if (studentData) {
                    status = studentData.status || 'never';
                    votesCount = studentData.votesCount || 0;
                    lastActivity = studentData.lastActivity;
                }

                let statusClass = 'status-never';
                let statusText = 'Not Active';
                if (status === 'online') {
                    statusClass = 'status-online';
                    statusText = 'Online';
                } else if (status === 'offline') {
                    statusClass = 'status-offline';
                    statusText = 'Offline';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${sanitizeInput(studentName)}</strong></td>
                    <td>${sanitizeInput(studentEmail)}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td><strong>${votesCount}</strong> / 18</td>
                    <td>${formatTime(lastActivity)}</td>
                    <td>
                        <button class="btn-delete" onclick="deleteStudent('${student.id}', '${sanitizeInput(studentName).replace(/'/g, "\\'")}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        window.deleteStudent = async function(studentId, studentName) {
            if (!confirm(`Are you sure you want to delete student "${studentName}"?\n\nThis will remove them from the registered students list.`)) {
                return;
            }

            try {
                await remove(ref(db, `registeredStudents/${studentId}`));
                
                await logAction('student_deleted', true, { studentId, studentName });

                alert(`Student "${studentName}" has been deleted.`);
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('Error deleting student. Please try again.');
            }
        };

        function formatTime(timestamp) {
            if (!timestamp) return 'Never';
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        window.filterStudents = function() {
            const searchTerm = sanitizeInput(document.getElementById('studentSearch').value.toLowerCase());
            const rows = document.querySelectorAll('#studentsTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        };

        function renderResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            categories.forEach(category => {
                const categoryVotes = allVotes[category.name] || {};
                const sortedNominees = category.nominees
                    .map(nom => ({ name: nom, votes: categoryVotes[nom] || 0 }))
                    .sort((a, b) => b.votes - a.votes);

                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <div class="result-header">${category.icon} <span>${sanitizeInput(category.name)}</span></div>
                    <div>
                        ${sortedNominees.map(nominee =>
                            `<div class="nominee-result">
                                <span class="nominee-name">${sanitizeInput(nominee.name)}</span>
                                <span class="nominee-votes">${nominee.votes}</span>
                            </div>`
                        ).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.exportResults = async function() {
            try {
                let csvContent = "Category,Nominee,Votes\n";
                categories.forEach(category => {
                    const categoryVotes = allVotes[category.name] || {};
                    category.nominees.forEach(nominee => {
                        const votes = categoryVotes[nominee] || 0;
                        csvContent += `"${category.name}","${nominee}",${votes}\n`;
                    });
                });

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `voting_results_${Date.now()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                await logAction('results_exported', true);

                alert('Results exported successfully!');
            } catch (error) {
                alert('Error exporting results.');
                console.error('Export error:', error);
            }
        };

        window.toggleVoting = async function() {
            try {
                await set(ref(db, 'settings/votingLocked'), !votingLocked);
                await logAction(votingLocked ? 'voting_unlocked' : 'voting_locked', true);
            } catch (error) {
                alert('Error toggling voting lock.');
                console.error('Toggle voting error:', error);
            }
        };

        window.resetVotes = async function() {
            if (!confirm('Are you sure you want to reset ALL votes? This cannot be undone.')) return;
            if (!confirm('FINAL WARNING: This will permanently delete all voting data. Continue?')) return;
            
            try {
                await remove(ref(db, 'categoryVotes'));
                await remove(ref(db, 'userVotes'));
                
               const studentsSnapshot = await get(ref(db, 'students'));
if (studentsSnapshot.exists()) {
    const students = studentsSnapshot.val();
    for (const key of Object.keys(students)) {
        await update(ref(db, `students/${key}`), {
            votesCount: 0,
            hasVoted: false
        });
    }
}
                
                await logAction('votes_reset', true);
                alert('All votes have been reset.');
            } catch (error) {
                alert('Error resetting votes.');
                console.error('Reset votes error:', error);
            }
        };

        document.getElementById('passwordInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                handleAdminLogin();
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('passwordInput').focus();
        });
    </script>
</body>
</html>
